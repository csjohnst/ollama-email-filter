version: '3.8'

services:
  email-assistant:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: email-assistant
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      # Required Email Settings
      - EMAILASSISTANT_EmailSettings__Username=${EMAIL_USERNAME}
      - EMAILASSISTANT_EmailSettings__Password=${EMAIL_PASSWORD}
      - EMAILASSISTANT_EmailSettings__Host=${EMAIL_HOST}

      # Optional Email Settings (with defaults)
      - EMAILASSISTANT_EmailSettings__Port=${EMAIL_PORT:-993}
      - EMAILASSISTANT_EmailSettings__EmailCount=${EMAIL_COUNT:-100}
      - EMAILASSISTANT_EmailSettings__MaxBodyLength=${EMAIL_MAX_BODY_LENGTH:-2000}
      - EMAILASSISTANT_EmailSettings__IncludeReadEmails=${EMAIL_INCLUDE_READ:-false}

      # Service Settings
      - EMAILASSISTANT_ServiceSettings__PollingIntervalMinutes=${POLLING_INTERVAL_MINUTES:-5}
      - EMAILASSISTANT_ServiceSettings__HealthCheckPort=8080
      - EMAILASSISTANT_ServiceSettings__MaxRetryAttempts=${MAX_RETRY_ATTEMPTS:-3}
      - EMAILASSISTANT_ServiceSettings__RetryDelaySeconds=${RETRY_DELAY_SECONDS:-30}

      # AI Provider Selection (ollama, openai, azureopenai, anthropic)
      - EMAILASSISTANT_AISettings__Provider=${AI_PROVIDER:-ollama}

      # Ollama Settings (when using Ollama)
      - EMAILASSISTANT_AISettings__Ollama__BaseUrl=${OLLAMA_BASE_URL:-http://ollama:11434}
      - EMAILASSISTANT_AISettings__Ollama__ModelName=${OLLAMA_MODEL:-llama3}

      # OpenAI Settings (when using OpenAI)
      - EMAILASSISTANT_AISettings__OpenAI__ApiKey=${OPENAI_API_KEY:-}
      - EMAILASSISTANT_AISettings__OpenAI__Model=${OPENAI_MODEL:-gpt-4.1-nano}

      # Azure OpenAI Settings (when using Azure OpenAI)
      - EMAILASSISTANT_AISettings__AzureOpenAI__ApiKey=${AZURE_OPENAI_API_KEY:-}
      - EMAILASSISTANT_AISettings__AzureOpenAI__Endpoint=${AZURE_OPENAI_ENDPOINT:-}
      - EMAILASSISTANT_AISettings__AzureOpenAI__DeploymentName=${AZURE_OPENAI_DEPLOYMENT:-}
      - EMAILASSISTANT_AISettings__AzureOpenAI__ApiVersion=${AZURE_OPENAI_API_VERSION:-2024-02-15-preview}

      # Anthropic Settings (when using Anthropic)
      - EMAILASSISTANT_AISettings__Anthropic__ApiKey=${ANTHROPIC_API_KEY:-}
      - EMAILASSISTANT_AISettings__Anthropic__Model=${ANTHROPIC_MODEL:-claude-3-haiku-20240307}

      # Category Settings (optional email categorization into subfolders)
      - EMAILASSISTANT_CategorySettings__EnableCategories=${ENABLE_CATEGORIES:-false}
      - EMAILASSISTANT_CategorySettings__Categories__Bills__Enabled=${CATEGORY_BILLS_ENABLED:-true}
      - EMAILASSISTANT_CategorySettings__Categories__Shopping__Enabled=${CATEGORY_SHOPPING_ENABLED:-true}
      - EMAILASSISTANT_CategorySettings__Categories__Work__Enabled=${CATEGORY_WORK_ENABLED:-true}
      - EMAILASSISTANT_CategorySettings__Categories__Personal__Enabled=${CATEGORY_PERSONAL_ENABLED:-true}
      - EMAILASSISTANT_CategorySettings__Categories__Education__Enabled=${CATEGORY_EDUCATION_ENABLED:-false}
      - EMAILASSISTANT_CategorySettings__Categories__Social__Enabled=${CATEGORY_SOCIAL_ENABLED:-false}
      - EMAILASSISTANT_CategorySettings__Categories__Events__Enabled=${CATEGORY_EVENTS_ENABLED:-false}
      - EMAILASSISTANT_CategorySettings__Categories__Travel__Enabled=${CATEGORY_TRAVEL_ENABLED:-false}
      - EMAILASSISTANT_CategorySettings__Categories__Finance__Enabled=${CATEGORY_FINANCE_ENABLED:-false}
      - EMAILASSISTANT_CategorySettings__Categories__Health__Enabled=${CATEGORY_HEALTH_ENABLED:-false}

      # Logging
      - Logging__LogLevel__Default=Information
      - Logging__LogLevel__OllamaEmailFilter=Debug

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    networks:
      - email-assistant-network

networks:
  email-assistant-network:
    driver: bridge
